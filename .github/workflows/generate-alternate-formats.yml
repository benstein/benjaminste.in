name: Generate Alternate Formats

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Generate alternate formats
        run: |
          ruby <<'RUBY'
          require 'json'
          require 'yaml'
          require 'date'

          # Load site config
          config = YAML.load_file('_config.yml')
          site_url = config['url'] || 'https://benjaminste.in'
          author = config['author'] || 'Benjamin Stein'

          # Process each post
          Dir.glob('_posts/*.md').each do |post_file|
            content = File.read(post_file)

            # Parse front matter
            if content =~ /\A(---\s*\n.*?\n?)^(---\s*$\n?)/m
              front_matter = YAML.safe_load($1, permitted_classes: [Date, Time])
              post_content = $'

              # Extract date from filename
              basename = File.basename(post_file, '.md')
              date_match = basename.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/)
              next unless date_match

              year, month, day, slug = date_match[1..4]

              # Build URLs
              post_url = "/blog/#{year}/#{month}/#{day}/#{slug}/"
              output_dir = "_site#{post_url}"

              # Ensure output directory exists
              FileUtils.mkdir_p(output_dir)

              # Create JSON version
              json_data = {
                "title" => front_matter['title'],
                "date" => "#{year}-#{month}-#{day}",
                "author" => author,
                "categories" => front_matter['categories'] || [],
                "excerpt" => front_matter['excerpt'],
                "url" => post_url,
                "content" => post_content.strip,
                "html_url" => "#{site_url}#{post_url}",
                "json_url" => "#{site_url}#{post_url}index.json",
                "markdown_url" => "#{site_url}#{post_url}index.md"
              }

              File.write("#{output_dir}/index.json", JSON.pretty_generate(json_data))

              # Create Markdown version
              md_content = "# #{front_matter['title']}\n\n"
              md_content += "**Date:** #{year}-#{month}-#{day}\n\n"
              md_content += "**Author:** #{author}\n\n"

              if front_matter['categories'] && !front_matter['categories'].empty?
                md_content += "**Categories:** #{front_matter['categories'].join(', ')}\n\n"
              end

              md_content += "---\n\n"
              md_content += post_content.strip

              File.write("#{output_dir}/index.md", md_content)

              puts "Generated alternate formats for: #{front_matter['title']}"
            end
          end
          RUBY

      - name: Commit alternate formats
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add _site/**/*.json _site/**/*.md 2>/dev/null || true
          git diff --staged --quiet || git commit -m "Generate alternate formats for blog posts [skip ci]"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
